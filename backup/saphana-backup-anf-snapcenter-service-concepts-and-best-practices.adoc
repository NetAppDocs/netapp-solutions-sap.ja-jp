---
sidebar: sidebar 
permalink: backup/saphana-backup-anf-snapcenter-service-concepts-and-best-practices.html 
keywords:  
summary:  
---
= SnapCenter サービスの概念とベストプラクティス
:hardbreaks:
:nofooter: 
:icons: font
:linkattrs: 
:imagesdir: ./../media/


link:saphana-backup-anf-snapcenter-service-sap-hana-backup-solution.html["前のバージョン： SnapCenter サービス SAP HANA バックアップ解決策。"]



== データ保護戦略

SnapCenter サービスを設定する前に、各種 SAP システムの RTO と RPO の要件に基づいてデータ保護戦略を定義する必要があります。

一般的なアプローチとしては、本番システム、開発システム、テストシステム、サンドボックスシステムなどのシステムタイプを定義します。通常、システムタイプが同じ SAP システムのデータ保護パラメータはすべて同じです。

次のパラメータを定義する必要があります。

* Snapshot バックアップを実行する頻度
* Snapshot バックアップを保持する期間
* ブロック整合性チェック（ファイルベースのバックアップ）を実行する頻度
* ブロック整合性チェックのバックアップ（ファイルベースのバックアップ）を保持する期間


次の表に、システムタイプの本番、開発、およびテストのデータ保護パラメータの例を示します。本番用システムでは、高いバックアップ頻度が定義され、週単位のファイルベースのバックアップが実行されます。テスト用システムと開発用システムの要件は低く、 Snapshot バックアップのスケジュールも設定頻度が低くなっています。

|===
| パラメータ | 本番用システム | 開発システム | システムをテストする 


| Snapshot のバックアップ頻度 | 4 時間ごと | 6 時間ごと | 12 時間ごと 


| Snapshot バックアップの保持 | 3 日 | 3 日 | 3 日 


| ブロック整合性チェックの頻度 | 週に 1 回 | 週に 1 回 | 週に 1 回 


| ブロック整合性チェックの保持 | 4 週間 | 2 週間 | 1 週間 
|===
次の表に、 Snapshot バックアップ処理のデータ保護パラメータに設定する必要があるポリシーを示します。

|===
| パラメータ | Policy SnapshotEvery4h 」を参照してください | Policy SnapshotEvery6h に追加されました | Policy SnapshotEvery12h 」を参照してください 


| バックアップタイプ | Snapshot コピーベース | Snapshot コピーベース | Snapshot コピーベース 


| スケジュールタイプ | 毎時 | 毎時 | 毎時 


| 保持 | カウント = 18 | カウント = 12 | カウント = 3 


| バックアップスケジュール | 4 時間ごと | 6 時間ごと | 12 時間ごと 
|===
次の表に、ファイルベースのバックアップ処理のデータ保護パラメータに設定する必要があるポリシーを示します。

|===
| パラメータ | Policy FileBased4Week の 2 つのグループがあります | ポリシー FileBased2Weeks | Policy FileBased1Week のいずれかです 


| バックアップタイプ | ファイルベース | ファイルベース | ファイルベース 


| スケジュールタイプ | 毎週 | 毎週 | 毎週 


| 保持 | カウント = 4 | カウント = 2 | count = 1 


| バックアップスケジュール | 毎週日曜日 | 毎週日曜日 | 毎週日曜日 
|===


=== SnapCenter サービスポリシー

SnapCenter サービスでは、単一の保護ポリシーに次のパラメータが含まれています。

* バックアップタイプ
+
** Snapshot ベース
** ファイルベース


* スケジュールと保持
+
** スケジュール：毎時、毎日、毎週、毎月。1 つのポリシーに複数のスケジュールを設定できます。
** 各スケジュールについて、開始時間または終了時間と頻度を設定します。
** 保持期間はスケジュールごとに設定します。保持期間には時間ベースのデータとカウンタベースのデータがあります。




次の図は、ポリシーの設定のスクリーンショットです。

image:saphana-backup-anf-image10.png["エラー：グラフィックイメージがありません"]



== バックアップ処理

SAP は、 HANA 2.0 SPS4 を使用する MDC のマルチテナントシステムの Snapshot バックアップをサポートするようになりました。SAP HANA MDC システムでは、テナント構成が静的であるとは限りません。テナントを追加または削除できます。SnapCenter サービスは、 HANA データベースが SnapCenter に追加されたときに検出された構成に依存しません。SnapCenter サービスは、バックアップ処理の実行時点で利用可能なテナントを把握しておく必要があります。

したがって、バックアップ処理を実行するたびに、テナント情報を取得する必要があります。次のステップは、 Snapshot バックアップ処理そのものです。この手順には、 HANA のバックアップセーブポイント、 Azure NetApp Files の Snapshot バックアップ、および HANA のバックアップセーブポイントを閉じる SQL コマンドが含まれています。close コマンドを使用すると、システムデータベースと各テナントのバックアップカタログが HANA データベースによって更新されます。


NOTE: SAP では、 1 つ以上のテナントが停止している場合に MDC システムの Snapshot バックアップ処理はサポートされません。

データバックアップの保持管理と HANA のバックアップカタログ管理のために、 SnapCenter サービスでは、最初の手順で特定されたシステムデータベースとすべてのテナントデータベースに対してカタログ削除処理を実行する必要があります。ログバックアップの場合と同様に、 SnapCenter サービスワークフローは、バックアップ処理の一部であった各テナントに対して実行する必要があります。

次の図に、バックアップワークフローの概要を示します。

image:saphana-backup-anf-image11.jpg["エラー：グラフィックイメージがありません"]



=== HANA データベースの Snapshot バックアップのワークフロー

SnapCenter サービスは、 SAP HANA データベースのバックアップを次の順序で実行します。

. HANA データベースからテナントのリストを読み取ります。
. バックアップ処理のために、テナント情報を SnapCenter サービスメタデータに格納します。
. SAP HANA のグローバル同期バックアップセーブポイントをトリガーして、整合性のあるデータベースイメージを永続性レイヤに作成します。
+
SAP HANA MDC のシングルまたはマルチテナントシステムの場合は、システムデータベースと各テナントデータベースの同期されたグローバルバックアップセーブポイントが作成されます。

. HANA システム用に構成されたすべてのデータボリュームの Azure NetApp Files Snapshot コピーを作成します。このシングルホスト HANA データベースの例には、データボリュームが 1 つしかありません。SAP HANA マルチホストデータベースには、複数のデータボリュームがあります。
. SAP HANA バックアップカタログに Azure NetApp Files Snapshot バックアップを登録します。
. SAP HANA のバックアップセーブポイントを削除します。
. バックアップ用に定義された保持ポリシーに基づいて、データベースおよび SAP HANA バックアップカタログから Azure NetApp Files Snapshot コピーとバックアップエントリを削除します。HANA のバックアップカタログ処理は、システムデータベースとすべてのテナントに対して実行されます。
. ファイルシステムと SAP HANA のバックアップカタログにある、 SAP HANA のバックアップカタログにある最も古いデータバックアップよりも古いすべてのログバックアップを削除します。これらの処理はシステムデータベースおよびすべてのテナントに対して実行されます。




=== ブロック整合性チェック処理のバックアップワークフロー

SnapCenter サービスは、次の順序でブロック整合性チェックを実行します。

. HANA データベースからテナントのリストを読み取ります。
. システムデータベースおよび各テナントに対してファイルベースのバックアップ処理をトリガーします。
. ブロック整合性チェック処理用に定義された保持ポリシーに基づいて、データベース、ファイルシステム、および SAP HANA のバックアップカタログからファイルベースのバックアップを削除します。ファイルシステムと HANA のバックアップカタログに関するバックアップの削除は、システムデータベースとすべてのテナントに対して実行されます。
. ファイルシステムと SAP HANA のバックアップカタログにある、 SAP HANA のバックアップカタログにある最も古いデータバックアップよりも古いすべてのログバックアップを削除します。これらの処理はシステムデータベースおよびすべてのテナントに対して実行されます。




== バックアップ保持管理、および不要なデータバックアップとログバックアップの削除

データバックアップ保持管理とログバックアップの不要ファイルの削除は、次の保持管理を含む 4 つのメイン領域に分割できます。

* Snapshot バックアップ
* ファイルベースのバックアップ
* SAP HANA のバックアップカタログでのデータのバックアップ
* SAP HANA のバックアップカタログとファイルシステムにバックアップを記録します


次の図は、各種ワークフローの概要と各処理の依存関係を示しています。以降のセクションでは、さまざまな処理について詳しく説明します。

image:saphana-backup-anf-image12.png["エラー：グラフィックイメージがありません"]



=== Snapshot バックアップの保持管理

SnapCenter で Snapshot バックアップを手動で削除することもできます。



=== ファイルベースのバックアップの保持管理

SnapCenter サービスは、 SnapCenter サービスのバックアップポリシーで定義された保持設定に従って、ファイルシステム上のバックアップを削除することで、ファイルベースのバックアップを削除します。



=== SAP HANA のバックアップカタログ内でのデータバックアップの保持管理

SnapCenter サービスがバックアップ（ Snapshot またはファイルベース）を削除すると、このデータバックアップは SAP HANA のバックアップカタログからも削除されます。



=== ログバックアップの保持管理

SAP HANA データベースでは、ログバックアップが自動的に作成されます。このログバックアップでは、 SAP HANA で構成されたバックアップディレクトリに、個々の SAP HANA サービスごとにバックアップファイルが作成されます。

最新のデータバックアップよりも古いログバックアップはフォワードリカバリには不要になり、削除することができます。

SnapCenter サービスは、ファイルシステムレベルおよび SAP HANA バックアップカタログでの不要なログファイルバックアップの削除を次のタスクで処理します。

. SAP HANA のバックアップカタログを読み取り、成功した最も古いファイルベースバックアップまたは Snapshot バックアップのバックアップ ID を取得します。
. このバックアップ ID よりも古い SAP HANA カタログとファイルシステムのすべてのログバックアップを削除します。
+
SnapCenter サービスは、 SnapCenter で作成されたバックアップの不要な削除のみを処理します。SnapCenter の外部で追加のファイルベースのバックアップを作成する場合は、ファイルベースのバックアップがバックアップカタログから削除されていることを確認する必要があります。このようなデータバックアップがバックアップカタログから手動で削除されないと、最も古いデータバックアップになる可能性があります。また、このファイルベースのバックアップが削除されるまで、古いログバックアップは削除されません。




NOTE: 現在のリリースの SnapCenter サービスでは、ログバックアップの保持管理をオフにすることはできません。



== Snapshot バックアップに必要な容量

従来のデータベースの変更率と比較して、ストレージレイヤのブロック変更率が高いことを考慮する必要があります。列ストアの HANA テーブルのマージプロセスにより、テーブル全体が変更されたブロックだけでなくディスクに書き込まれます。1 日に複数の Snapshot バックアップを作成した場合、顧客ベースから得られるデータの日次変更率は 20~50% です。

link:saphana-backup-anf-lab-setup-used-for-this-report.html["次：このレポートに使用するラボのセットアップ。"]
