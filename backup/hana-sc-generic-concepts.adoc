---
sidebar: sidebar 
permalink: backup/hana-sc-generic-concepts.html 
keywords: SAP HANA, SnapCenter, backup and recovery, Azure NetApp Files, FSx for NetApp ONTAP 
summary:  
---
= SnapCenter のデータ保護の概念とベストプラクティスについて学習します
:allow-uri-read: 


[role="lead"]
SAP HANA 環境向けのSnapCenterの展開オプション、データ保護戦略、バックアップ保持管理について学習します。SnapCenter は、データベース ホストまたは中央ホストへのプラグインの展開、自動検出と手動構成、ファイルベースのバックアップまたは hdbpersdiag を使用したブロック整合性チェック、プライマリ ストレージとセカンダリ ストレージにわたる包括的な保持管理をサポートします。



== SAP HANA 向けSnapCenterプラグインの導入オプション

次の図は、 SnapCenterサーバー、SAP HANA データベース、およびストレージ システム間の通信の論理ビューを示しています。SnapCenterサーバーは、HANA と Linux プラグインを活用して、HANA データベースおよび Linux オペレーティング システムと通信します。

image:hana-sc-generic-image-008.png["幅=601、高さ=199"]

SnapCenterプラグインの推奨されるデフォルトの展開オプションは、HANA データベース ホストへのインストールです。この展開オプションでは、 「SnapCenterでサポートされる構成」の章で説明されているすべての構成と機能が有効になります。いくつかの例外があり、 SnapCenterプラグインを HANA データベース ホストにインストールできず、中央プラグイン ホスト ( SnapCenterサーバー自体など) で構成する必要があります。HANA 複数ホスト システムまたは IBM Power プラットフォーム上で実行される HANA システムには、中央プラグイン ホストが必要です。両方の展開オプションを組み合わせることもできます。たとえば、 SnapCenterサーバーを複数のホスト システムの中央プラグイン ホストとして使用し、他のすべての単一ホスト HANA システムの HANA データベース ホストにプラグインを展開するなどです。

SnapCenterでは、HANA リソースを自動検出するか、手動で構成することができます。HANA および Linux プラグインがデータベース ホストにデプロイされるとすぐに、HANA システムがデフォルトで自動検出されます。SnapCenter の自動検出では、同じホスト上の複数の HANA インストールはサポートされません。中央プラグイン ホストを使用して管理される HANA システムは、 SnapCenterで手動で構成する必要があります。また、非データ ボリュームは、デフォルトでは手動で構成されたリソースです。

[cols="29%,34%,37%"]
|===
|  | プラグインの導入場所 | SnapCenterリソース 


| HANAデータベース | データベースホスト | 自動検出 


| HANAデータベース | 中央プラグインホスト | 手動設定 


| 非データ量 | N/A | 手動設定 
|===
SnapCenter はHANA システムの中央プラグイン展開をサポートしていますが、プラットフォームと機能のサポートには制限があります。中央プラグイン ホストで構成された HANA システムでは、次のインフラストラクチャ構成と操作はサポートされません。

* FCデータストアを備えたVMware
* SnapMirrorアクティブ同期
* 中央プラグインホストとして使用した場合のSnapCenterサーバーの高可用性
* HANAシステムの自動検出
* 自動HANAデータベースリカバリ
* 自動SAPシステムリフレッシュ
* 単一テナントの復元




=== SAP HANA データベース ホストに導入された HANA 用SnapCenterプラグイン

SnapCenterサーバーは、HANA プラグインを介して HANA データベースと通信します。HANA プラグインは、HANA hdbsql クライアント ソフトウェアを使用して、HANA データベースに対して SQL コマンドを実行します。HANA hdb ユーザーストアは、HANA データベースにアクセスするためのユーザー資格情報、ホスト名、およびポート情報を提供するために使用されます。SnapCenter Linux プラグインは、ホスト ファイル システムの操作だけでなく、ファイル システムとストレージ リソースの自動検出もカバーするために使用されます。

HANA プラグインが HANA データベース ホストにデプロイされると、HANA システムはSnapCenterによって自動検出され、 SnapCenterで自動検出されたリソースとしてフラグが付けられます。

image:hana-sc-generic-image-009.png["幅=601、高さ=304"]



=== SnapCenter サーバの高可用性

SnapCenter は2 ノードの HA 構成でセットアップできます。このような構成では、ロード バランサ (F5 など) を使用してSnapCenterホストにアクセスします。SnapCenterリポジトリ (MySQL データベース) はSnapCenterによって 2 つのホスト間で複製されるため、 SnapCenterデータは常に同期されます。

SnapCenterサーバーに HANA プラグインがインストールされている場合、 SnapCenterサーバー HA はサポートされません。SnapCenter HAの詳細については、以下をご覧ください。 https://docs.netapp.com/us-en/snapcenter/install/concept_configure_snapcenter_servers_for_high_availabiity_using_f5.html["SnapCenterサーバを高可用性向けに構成する"]。

image:hana-sc-generic-image-010.png["幅=601、高さ=307"]



=== 中央プラグインホスト

前の章で述べたように、中央プラグインは

* HANA 複数ホストシステム
* IBM Powerで稼働するHANAシステム


中央プラグイン ホストを使用する場合、HANA プラグインと SAP HANA hdbsql クライアントは、HANA データベース ホストの外部のホストにインストールする必要があります。このホストは、 SnapCenterサーバーなどの任意の Windows または Linux ホストにすることができます。


NOTE: SnapCenterサーバーを Windows 上で実行する場合、Windows システムを中央プラグイン ホストとして使用できます。Linux 上でSnapCenterサーバーを実行する場合は、中央プラグイン ホストとして別のホストを使用する必要があります。

HANA 複数ホスト システムの場合、すべてのワーカー ホストとスタンバイ ホストの SAP HANA ユーザー ストア キーを中央プラグイン ホストで設定する必要があります。SnapCenter は、提供された各キーを使用してデータベースに接続しようとするため、システム データベース (HANA ネーム サーバー) の別のホストへのフェイルオーバーとは独立して動作できます。

image:hana-sc-generic-image-011.png["幅=601、高さ=314"]

中央プラグイン ホストによって管理される複数の単一ホスト HANA システムの場合、HANA システムの個々の SAP HANA ユーザー ストア キーはすべて、中央プラグイン ホストで設定する必要があります。

image:hana-sc-generic-image-012.png["幅=601、高さ=338"]



== SAP HANA ブロック整合性チェック

SAP では、全体的なバックアップ戦略に定期的な HANA ブロック整合性チェックを含めることを推奨しています。従来のファイルベースのバックアップでは、このチェックはバックアップ操作ごとに実行されます。スナップショット バックアップでは、スナップショット バックアップ操作に加えて、たとえば週に 1 回、整合性チェックを実行する必要があります。

技術的には、ブロック整合性チェックを実行するには 2 つのオプションがあります。

* 標準のファイルベースまたはbackintベースのバックアップを実行する
* HANAツールhdbpersdiagの実行については、以下も参照してください。 https://help.sap.com/docs/SAP_HANA_PLATFORM/6b94445c94ae495c83a19646e7c3fd56/60e110ea8f9e457095210115487e11a6.html?locale=en-US&state=PRODUCTION&version=2.0.08&q=hdbpersdiag["永続性整合性チェック | SAP ヘルプポータル"]


HANA hdbpersdiag ツールは HANA インストールの一部であり、オフライン HANA データベースに対してブロック整合性チェック操作を実行できます。したがって、既存のスナップショット バックアップを hdbpersdiag に提示できるスナップショット バックアップと組み合わせて使用するのに最適です。

2 つのアプローチを比較すると、hdbpersdiag は HANA ブロック整合性チェックのファイルベースのバックアップに比べて大きな利点があります。1 つの次元は必要なストレージ容量です。ファイルベースのバックアップでは、各 HANA システムに対して少なくとも 1 つのバックアップのサイズが利用可能である必要があります。たとえば、永続サイズが 3 TB の HANA システムが 15 台ある場合、整合性チェックのためだけにさらに 45 TB が必要になります。hdbpersdiag では、既存のスナップショット バックアップまたは既存のスナップショット バックアップのFlexCloneに対して操作が実行されるため、追加のストレージ容量は必要ありません。2 番目の次元は、整合性チェック操作中の HANA ホストの CPU 負荷です。ファイルベースのバックアップでは HANA データベース ホストで CPU サイクルが必要になりますが、中央検証ホストと組み合わせて使用​​すると、hdbpersdiag 処理は HANA ホストから完全にオフロードできます。以下の表に主な特徴をまとめます。

[cols="34%,^33%,^33%"]
|===
|  | 必要なストレージ容量 | HANAホストのCPUとネットワーク負荷 


| ファイルベースのバックアップ | HANA システムごとに最小 1 x データ バックアップ サイズ | 高 


| HANA ホストのスナップショット ディレクトリを使用した hdbpersdiag (NFS のみ) | なし | 中 


| FlexCloneボリュームでhdbpersdiagを実行するために使用される中央検証ホスト | なし | なし 
|===
NetApp、HANA ブロックの整合性チェックを実行するために hdbpersdiag を使用することを推奨しています。実装の詳細については、次の章を参照してください。 link:hana-sc-generic-block-check.html["SnapCenterによるブロック整合性チェック"]。



== データ保護戦略

SnapCenter と SAP HANA プラグインを設定する前に、各種 SAP システムの RTO と RPO の要件に基づいてデータ保護戦略を定義する必要があります。

一般的なアプローチとしては、本番システム、開発システム、テストシステム、サンドボックスシステムなどのシステムタイプを定義します。通常、システムタイプが同じ SAP システムのデータ保護パラメータはすべて同じです。

定義する必要があるパラメータは次のとおりです。

* Snapshot バックアップを実行する頻度
* Snapshot コピーバックアップをプライマリストレージシステムに保存する期間
* ブロック整合性チェックはどのくらいの頻度で実行する必要がありますか。
* プライマリ バックアップをセカンダリ バックアップ サイトに複製する必要がありますか?
* バックアップはセカンダリ バックアップ ストレージにどれくらいの期間保存する必要がありますか?


次の表は、システム タイプ運用、開発、テストのデータ保護パラメータの例を示しています。実稼働システムでは、高いバックアップ頻度が定義されており、バックアップは 1 日に 1 回セカンダリ バックアップ サイトに複製されます。テスト システムでは要件が低く、バックアップのレプリケーションは行われません。

[cols="25%,25%,25%,25%"]
|===
| パラメータ | 本番用システム | 開発システム | システムをテストする 


| バックアップ頻度 | 6 時間ごと | 6 時間ごと | 12時間ごと 


| プライマリの保持 | 3 日 | 3 日 | 6日間 


| ブロック整合性チェック | 週に 1 回 | 週に 1 回 | いいえ 


| セカンダリバックアップサイトへのレプリケーション | 1 日に 1 回 | 1 日に 1 回 | いいえ 


| セカンダリバックアップの保持 | 2 週間 | 2 週間 | いいえ 
|===
次の表は、上記のデータ保護パラメータに対して構成する必要があるポリシーとスケジュールを示しています。

[cols="24%,23%,13%,12%,14%,14%"]
|===
| ポリシー | バックアップタイプ | スケジュール頻度 | プライマリの保持 | SnapVault レプリケーション | 二次保持 


| ローカルスナップ | Snapshot ベース | 6 時間ごと | カウント=12 | いいえ | 該当なし 


| ローカルスナップとスナップボールト | Snapshot ベース | 1 日に 1 回 | カウント=2 | はい。 | カウント=14 


| SnapAndCallHdbpersdiag | Snapshot ベース | 週に 1 回 | カウント=2 | いいえ | 該当なし 
|===

NOTE: ONTAPシステムまたは FSx for ONTAPの場合、 SnapCenter がSnapVault更新操作を実行する前に、 ONTAPでSnapVaultレプリケーションのデータ保護関係を設定する必要があります。セカンダリ保持は、 ONTAP保護ポリシー内で定義されます。


NOTE: ANF バックアップの場合、 SnapCenterの外部で追加の構成は必要ありません。ANF バックアップのセカンダリ保持はSnapCenterによって管理されます。


NOTE: この例の構成では、ブロック整合性チェック操作に hdbpersdiag が使用されます。詳細については、次の章をご覧ください。 link:hana-sc-generic-block-check.html["SnapCenterによるブロック整合性チェック"]。

以下の図は、スケジュールとバックアップの保持期間をまとめたものです。SnapCenterを使用してログ バックアップの保持を管理する場合、最も古いスナップショット バックアップよりも古いログ バックアップはすべて削除されます。つまり、ログ バックアップは、利用可能なすべてのバックアップを最新の状態に回復するために必要な期間保持されます。

image:hana-sc-generic-image-013.png["幅=601、高さ=192"]



== 暗号化ルートキーのバックアップ

HANA 永続暗号化を使用する場合は、標準のデータ バックアップに加えて、ルート キーのバックアップを作成することが重要です。データ ボリュームと HANA インストール ファイル システムが失われた場合に HANA データベースを回復するには、ルート キーのバックアップが必要です。詳細については、 https://help.sap.com/docs/SAP_HANA_PLATFORM/6b94445c94ae495c83a19646e7c3fd56/b1e7562e2c704c19bd86f2f9f4feedc4.html["『 SAP HANA Administration Guide 』をご覧ください"]。


NOTE: ルート キーが変更された場合、新しいルート キーを使用して、以前に作成された古い HANA データベース バックアップを復元することはできないことに注意してください。バックアップの作成時にアクティブだったルート キーが常に必要になります。



== バックアップ処理

SnapCenter は、単一または複数のテナントを持つ HANA MDC システムのスナップショット バックアップ操作をサポートします。SnapCenter は、HANA MDC システムの 2 つの異なる復元操作もサポートしています。システム全体、システム DB、およびすべてのテナントを復元することも、1 つのテナントだけを復元することもできます。SnapCenter がこれらの操作を実行できるようにするには、いくつかの前提条件があります。

MDC システムでは、テナント構成は必ずしも静的ではありません。テナントを追加したり、テナントを削除したりできます。SnapCenter は、HANA データベースがSnapCenterに追加されたときに検出された構成に依存できません。単一テナントの復元操作を有効にするには、 SnapCenter は各スナップショット バックアップに含まれるテナントを認識する必要があります。さらに、スナップショット バックアップに含まれる各テナントに属するファイルとディレクトリを認識する必要があります。

したがって、バックアップ操作ごとに、 SnapCenter はテナント情報を識別します。これには、テナント名と対応するファイルおよびディレクトリ情報が含まれます。単一テナントの復元操作をサポートできるようにするには、このデータをスナップショット バックアップ メタデータに保存する必要があります。

アプリケーション自動検出のもう 1 つのステップは、HANA システム レプリケーション (HSR) のプライマリ ノードまたはセカンダリ ノードの検出です。HANA システムが HSR で構成されている場合、バックアップ SQL コマンドが HSR プライマリ ノードで実行されるように、 SnapCenter は各バックアップ操作でプライマリ ノードを識別する必要があります。参照 https://docs.netapp.com/us-en/netapp-solutions-sap/backup/hana-sr-scs-system-replication-overview.html["『SAP HANA System Replication - Backup and Recovery with SnapCenter』"]。

SnapCenter はHANA データ ボリューム構成も検出し、それをファイル システムとストレージ リソースにマッピングします。このアプローチにより、 SnapCenter はHANA ボリューム構成の変更 (複数のパーティションやボリュームの移行などのストレージ構成の変更など) を処理できます。

次のステップは、スナップショット バックアップ操作そのものです。この手順には、HANA データベース スナップショット、ストレージ スナップショット バックアップをトリガーする SQL コマンド、および HANA スナップショット操作を終了する SQL コマンドが含まれます。close コマンドを使用することで、HANA データベースはシステム DB と各テナントのバックアップ カタログを更新します。


NOTE: SAP では、 1 つ以上のテナントが停止している場合に MDC システムの Snapshot バックアップ処理はサポートされません。

データバックアップの保持管理と HANA のバックアップカタログ管理のために、 SnapCenter では、最初の手順で特定されたシステムデータベースとすべてのテナントデータベースに対してカタログ削除処理を実行する必要があります。ログバックアップの場合と同様に、 SnapCenter ワークフローは、バックアップ処理の一部であった各テナントに対して実行する必要があります。

次の図に、バックアップワークフローの概要を示します。

image:hana-sc-generic-image-014.png["幅=601、高さ=237"]



== バックアップ保持管理

データバックアップ保持管理とログバックアップの不要ファイルの削除は、次の保持管理を含む 5 つのメイン領域に分割できます。

* プライマリストレージでのローカルバックアップ
* ファイルベースのバックアップ
* セカンダリストレージでのバックアップ（SnapVaultまたはANFバックアップ）
* SAP HANA のバックアップカタログでのデータのバックアップ
* SAP HANA バックアップカタログとファイルシステム上のログバックアップ


次の図は、各種ワークフローの概要と各処理の依存関係を示しています。以降のセクションでは、さまざまな処理について詳しく説明します。

image:hana-sc-generic-image-015.png["幅=601、高さ=309"]



=== プライマリストレージでのローカルバックアップの保持管理

SnapCenter は、 SnapCenterバックアップ ポリシーで定義された保持期間に従って、プライマリ ストレージ上およびSnapCenterリポジトリ内の Snapshot コピーを削除することにより、SAP HANA データベース バックアップと非データ ボリューム バックアップのハウスキーピングを処理します。保持管理は、 SnapCenterの各バックアップ ワークフローに含まれています。プライマリ ストレージのローカル バックアップも、 SnapCenterで手動で削除できます。



=== ファイルベースのバックアップの保持管理

SnapCenter は、 SnapCenterバックアップ ポリシーで定義された保持期間に従ってファイル システム上のバックアップを削除することにより、ファイルベースのバックアップのハウスキーピングを処理します。保持管理ロジックは、 SnapCenterの各バックアップ ワークフローで実行されます。



=== セカンダリストレージでのバックアップの保持管理（SnapVault）

セカンダリ ストレージ (SnapVault ) でのバックアップの保持管理は、 ONTAP保護関係で定義された保持に基づいてONTAPによって処理されます。SnapCenterリポジトリ内のセカンダリ ストレージ上のこれらの変更を同期するために、 SnapCenter はスケジュールされたクリーンアップ ジョブを使用します。このクリーンアップ ジョブは、すべてのSnapCenterプラグインとすべてのリソースのすべてのセカンダリ ストレージ バックアップをSnapCenterリポジトリと同期します。

クリーンアップ ジョブは、デフォルトで週に 1 回スケジュールされます。この週次スケジュールにより、セカンダリ ストレージで既に削除されているバックアップと比較すると、 SnapCenterおよび SAP HANA Studio でのバックアップの削除に遅延が生じます。この不一致を回避するために、顧客はスケジュールを 1 日 1 回など、より高い頻度に変更できます。クリーンアップジョブのスケジュールを調整する方法や手動で更新を開始する方法の詳細については、次の章を参照してください。 link:hana-sc-generic-backup-operations.html#cleanup-of-secondary-backups["セカンダリバックアップのクリーンアップ"]。



=== セカンダリストレージでのバックアップの保持管理（ANFバックアップ）

ANF バックアップの保持は、 SnapCenterによって構成および処理されます。SnapCenter は、 SnapCenterバックアップ ポリシーで定義された保持期間に従ってバックアップを削除することにより、ANF バックアップのハウスキーピングを処理します。保持管理は、 SnapCenterの各バックアップ ワークフローに含まれています。



=== SAP HANA のバックアップカタログ内でのデータバックアップの保持管理

SnapCenter がバックアップ、ローカル スナップショット、またはファイルベースを削除した場合、またはSnapCenter がセカンダリ ストレージでのバックアップの削除を識別した場合、このデータ バックアップは SAP HANA バックアップ カタログでも削除されます。プライマリ ストレージのローカル スナップショット バックアップの SAP HANA カタログ エントリを削除する前に、 SnapCenter はセカンダリ ストレージにバックアップがまだ存在するかどうかを確認します。



=== ログバックアップの保持管理

SAP HANA データベースはログ バックアップを自動的に作成します。これらの操作により、SAP HANA で設定されたバックアップ ディレクトリに、個々の SAP HANA サービスごとにバックアップ ファイルが作成されます。最新のデータ バックアップよりも古いログ バックアップは、フォワード リカバリには必要なくなるため、削除できます。SnapCenter は、次の手順を実行して、ファイルシステムレベルと SAP HANA バックアップカタログでのログファイルバックアップのハウスキーピングを処理します。

. SnapCenter はSAP HANA バックアップ カタログを読み取り、最も古い成功したデータ バックアップのバックアップ ID を取得します。
. SnapCenter は、 SAP HANA カタログ内のすべてのログバックアップと、このバックアップ ID よりも古いファイルシステムを削除します。



NOTE: SnapCenter では、 SnapCenter で作成されたバックアップの不要な削除のみが処理されます。SnapCenter の外部で追加のファイルベースのバックアップを作成する場合は、ファイルベースのバックアップがバックアップカタログから削除されていることを確認する必要があります。このようなデータバックアップがバックアップカタログから手動で削除されないと、最も古いデータバックアップになる可能性があります。また、このファイルベースのバックアップが削除されるまで、古いログバックアップは削除されません。


NOTE: ポリシー構成でオンデマンド バックアップの保持期間が定義されている場合でも、ハウスキーピングは別のオンデマンド バックアップが実行されたときにのみ実行されます。したがって、通常、オンデマンド バックアップはSnapCenterで手動で削除して、これらのバックアップが SAP HANA バックアップ カタログでも削除され、ログ バックアップ ハウスキーピングが古いオンデマンド バックアップに基づいていないことを確認する必要があります。


NOTE: ログ バックアップ保持管理はデフォルトで有効になっています。必要に応じて、「自動ログ バックアップ ハウスキーピングを非アクティブ化する」セクションで説明されているように無効にすることができます。
