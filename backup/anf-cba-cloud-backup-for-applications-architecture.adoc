---
sidebar: sidebar 
permalink: backup/anf-cba-cloud-backup-for-applications-architecture.html 
keywords: applications, anf, strategy, data protection, backup 
summary: Cloud Backup for Applicationsは、ネットアップクラウドストレージで実行されるアプリケーションにデータ保護機能を提供するSaaS解決策 です。NetApp BlueXPで利用できるCloud Backup for Applicationsは、Azure NetApp Files 上のSAP HANAに対して、アプリケーションと整合性のある効率的なポリシーベースの保護を提供します。Cloud Backup for Applicationsでは、一元的な管理と監視が可能です。同時に、アプリケーション固有のバックアップとリストア処理の管理をユーザに委譲することもできます。 
---
= Cloud Backup for Applicationsのアーキテクチャ
:hardbreaks:
:allow-uri-read: 
:nofooter: 
:icons: font
:linkattrs: 
:imagesdir: ./../media/


link:anf-cba-use-cases-and-value-of-accelerated-backup-and-cloning-operations_overview.html["以前：Cloud Backup for Applicationsのアーキテクチャの概要"]

[role="lead"]
Cloud Backup for Applicationsは、ネットアップクラウドストレージで実行されるアプリケーションにデータ保護機能を提供するSaaS解決策 です。NetApp BlueXPで利用できるCloud Backup for Applicationsは、Azure NetApp Files 上のSAP HANAに対して、アプリケーションと整合性のある効率的なポリシーベースの保護を提供します。Cloud Backup for Applicationsでは、一元的な管理と監視が可能です。同時に、アプリケーション固有のバックアップとリストア処理の管理をユーザに委譲することもできます。

Cloud Backup for Applicationsは、NetApp BlueXP内でSaaSとして実行され、フレームワークとUIを活用します。BlueXP作業環境フレームワークは、Azure NetApp Files のクレデンシャルの設定と管理に使用されます。

BlueXP Connectorをお客様のVNet内に導入する必要があります。ネットアップのSaaSコンポーネントとお客様の環境の間の通信は、コネクタを通じてのみ行われます。コネクタは、ANF管理APIを使用してANFストレージの処理を実行しています。

HANAプラグインは、HANAデータベース固有のロジックを提供するため、各HANAホストに導入する必要があります。HANAプラグインは、HANA hdbsqlクライアントとユーザストアキーを使用してHANAデータベースと通信します。すべてのデータベース処理はBlueXPコネクタによってトリガーされます。

image:anf-cba-image5.png["この図は、NetApp SaaSの基本アーキテクチャとお客様のネットワーク、Azureサブスクリプションを組み合わせたものです。"]



== 『Cloud Backup for Applications for SAP HANA on ANF』を参照してください



=== 解決策の概要

Cloud Backup for Applicationでは、次のコンポーネントに対してSnapshotベースのバックアップ処理がサポートされます。

. * SAP HANAシステム*データボリューム。
. * SAP HANAデータベースのデータボリューム以外のボリューム*。たとえば、などです `/hana/shared` ボリュームやSAPアプリケーションサーバのデータ
. *特定のHANAシステムに属していないグローバル非データボリューム*。たとえば、SAP転送ディレクトリなどです `/usr/sap/trans`。


これらのコンポーネントのバックアップ処理には、次のものがあります。

* スケジュールバックアップまたはオンデマンドバックアップ
* オプションのプリスクリプトとポストスクリプト
* ポリシーベースの保持管理
+
** （ANFボリュームレベルのSnapshot用）
** SAP HANAバックアップカタログ内（HANAデータボリュームのバックアップ用）




SAP HANAのファイルベースのバックアップは、データベースブロックの整合性チェックに使用され、オンデマンドまたはスケジュールされたバックアップ処理として実行することもできます。ポリシーベースの保持管理は、ファイルシステムレベルおよびHANAバックアップカタログ内で実行されます。

HANAデータベースのログバックアップの保持管理は、定義されたHANAデータベースデータバックアップの保持（Snapshotベースまたはファイルベース）に基づいて実行されます。

CBAでは、すべてのSnapshotベースバックアップのリストア処理がサポートされます。ファイルベースのバックアップは、ネイティブのHANAツールを使用してのみリストアできます。

image:anf-cba-image6.png["この図は、HANAシステムのマルチテナントデータベースコンテナとグローバルな非データボリュームのバックアップとリストアを示しています。"]



=== 解決策 の運用

Snapshotデータのバックアップは、Cloud Backup for Applicationsで実行されます。そのためには、ストレージレイヤで作成されるSnapshotコピーが、整合性のあるSAP HANAデータベースのイメージに基づいて作成されるように、SAP HANAデータベースのバックアップセーブポイントがトリガーされます。を参照してください https://help.sap.com/docs/SAP_HANA_PLATFORM/6b94445c94ae495c83a19646e7c3fd56/b41a2823576f4726be649bc98e61d62c.html?q=sap%20hana%20snapshot%20backup["SAPアドミニストレーションガイド"^] を参照してください。

SAP HANA関連のすべてのリソースを完全にバックアップできるように、Cloud Backup for Applicationsでは、ストレージベースのSnapshotコピーを使用してデータボリューム以外のすべてのボリュームをバックアップすることもできます。非データボリュームをデータベースデータバックアップとは別にスケジュール設定して、個別の保持ポリシーや保護ポリシーを有効にすることができます。

SAP では、ブロックの整合性チェックを実行するために、ストレージベースの Snapshot バックアップと週次ファイルベースのバックアップを組み合わせることを推奨しています。ブロック整合性チェックは、CBA内から実行できます。ブロック整合性チェック（ファイルベース）バックアップは、バックアップを別の格納場所にオフロードする目的でも使用されます。

Cloud Backup for Applicationsは、設定可能な保持ポリシーに基づいて、データバックアップ、ログバックアップ、SAP HANAバックアップカタログの削除を管理します。

次の図は、バックアップ解決策をまとめたものです。

image:anf-cba-image7.png["この図は、バックアップ解決策 をまとめたものです。"]

データ以外のボリュームのストレージベースのSnapshotバックアップを実行すると、Cloud Backup for Applicationsは次のタスクを実行します。

. データボリューム以外のストレージ Snapshot コピーを作成します。
. 定義した保持ポリシーに基づいてストレージ Snapshot コピーを削除します。


SAP HANAデータベースのストレージベースのSnapshotバックアップを実行すると、Cloud Backup for Applicationsは次のタスクを実行します。

. SAP HANA のバックアップセーブポイントを作成して、永続性レイヤに整合性のあるイメージを作成します。
. データボリュームのストレージ Snapshot コピーを作成します。
. SAP HANA バックアップカタログにストレージの Snapshot バックアップを登録します。
. SAP HANA のバックアップセーブポイントを解放します。
. 定義した保持ポリシーに基づいてストレージ Snapshot コピーを削除します。
. 定義された保持ポリシーに基づいて、 SAP HANA のバックアップカタログのエントリを削除します。
. データバックアップが手動または保持ポリシーに基づいて削除されるたびに、Cloud Backup for Applicationsは最も古いデータバックアップよりも古いログバックアップをすべて削除します。ログバックアップは、ファイルシステムと SAP HANA のバックアップカタログから削除されます。




=== サポートされている SAP HANA リリースと構成

Cloud Backup for Applicationsでは、単一テナントまたは複数テナントのHANA MDCシステムがサポートされ、次の構成オプションが用意されています。

* SAP HANA 2.0 SPS4 以降
* SAP HANAシングルホストシステム
* SAP HANAマルチホストシステム（を参照） link:anf-cba-backup-operations-with-hana-system-replication.html#backup-operations-with-hana-multiple-host-systems["『Backup operations with HANA multiple-host systems』"]
* の説明に従って、HANA System Replication（HSR）を使用して設定されたSAP HANAシステム link:anf-cba-backup-operations-with-hana-system-replication.html["『Backup Operations with HANA System Replication』"]




== Cloud Backup for Applicationsの概念とベストプラクティス



=== データ保護戦略

Cloud Backup for Applicationsを設定する前に、さまざまなSAPシステムのRTOとRPOの要件に基づいてデータ保護戦略を定義する必要があります。

一般的なアプローチは、本番システム、開発システム、テストシステム、サンドボックスシステムなどのシステムタイプを定義することです。通常、システムタイプが同じ SAP システムのデータ保護パラメータはすべて同じです。

次のパラメータを定義する必要があります。

* Snapshot バックアップを実行する頻度
* Snapshot バックアップを保持する期間
* ブロック整合性チェック（ファイルベースのバックアップ）を実行する頻度
* ブロック整合性チェックバックアップ（ファイルベースのバックアップ）を保持する期間


次の表に、本番、開発、テストの各システムタイプのデータ保護パラメータの例を示します。本番用システムでは、高いバックアップ頻度が定義され、週単位のファイルベースのバックアップが実行されます。テストシステムと開発システムの要件は低く、Snapshotバックアップのスケジュール設定頻度も低くなります。

|===
| パラメータ | 本番用システム | 開発システム | システムをテストする 


| Snapshot のバックアップ頻度 | 4 時間ごと | 6 時間ごと | 12 時間ごと 


| Snapshot バックアップの保持 | 3 日 | 3 日 | 3 日 


| ブロック整合性チェックの頻度 | 週に 1 回 | 週に 1 回 | 週に 1 回 


| ブロック整合性チェックの保持 | 4 週間 | 2 週間 | 1 週間 
|===
次の表に、 Snapshot バックアップ処理のデータ保護パラメータに設定する必要があるポリシーを示します。

|===
| パラメータ | Policy SnapshotEvery4h 」を参照してください | Policy SnapshotEvery6h に追加されました | Policy SnapshotEvery12h 」を参照してください 


| バックアップタイプ | Snapshot ベース | Snapshot ベース | Snapshot ベース 


| スケジュールタイプ | 毎時 | 毎時 | 毎時 


| 保持 | カウント = 18 | カウント = 12 | カウント = 3 


| バックアップスケジュール | 4 時間ごと | 6 時間ごと | 12 時間ごと 
|===
次の表に、ファイルベースのバックアップ処理のデータ保護パラメータに設定する必要があるポリシーを示します。

|===
| パラメータ | Policy FileBased4Week の 2 つのグループがあります | ポリシー FileBased2Weeks | Policy FileBased1Week のいずれかです 


| バックアップタイプ | ファイルベース | ファイルベース | ファイルベース 


| スケジュールタイプ | 毎週 | 毎週 | 毎週 


| 保持 | カウント = 4 | カウント = 2 | count = 1 


| バックアップスケジュール | 毎週日曜日 | 毎週日曜日 | 毎週日曜日 
|===


== バックアップ処理

SAPでは、HANA 2.0 SPS4を使用したMDCマルチテナントシステムでSnapshotバックアップのサポートが導入されました。SAP HANA MDC システムでは、テナント構成が静的であるとは限りません。テナントを追加または削除できます。Cloud Backup for Applicationsは、HANAデータベースがCloud Backup for Applicationsに追加されたときに検出された構成に依存することはできません。Cloud Backup for Applicationsは、バックアップ処理の実行時点で使用可能なテナントを認識している必要があります。

したがって、バックアップ処理を実行するたびに、テナント情報を取得する必要があります。次のステップは、 Snapshot バックアップ処理そのものです。この手順には、HANAバックアップセーブポイントとANF SnapshotバックアップをトリガーするSQLコマンド、HANAバックアップセーブポイントを閉じるSQLコマンドが含まれます。close コマンドを使用すると、システムデータベースと各テナントのバックアップカタログが HANA データベースによって更新されます。


NOTE: 1つ以上のテナントが停止している場合、SAP HANAはMDCシステムのSnapshotバックアップ処理をサポートしません。

データバックアップの保持管理とHANAバックアップのカタログ管理を行うには、Cloud Backup for Applicationsで、最初の手順で特定したシステムデータベースとすべてのテナントデータベースのカタログ削除処理を実行する必要があります。ログバックアップの場合も同様に、バックアップ処理の一部であった各テナントでCloud Backup for Applicationsワークフローを実行する必要があります。

次の図に、バックアップワークフローの概要を示します。

image:anf-cba-image8.png["この図は、バックアップワークフローの概要を示しています。"]



=== HANA データベースの Snapshot バックアップのワークフロー

Cloud Backup for Applicationsでは、SAP HANAデータベースが次の順序でバックアップされます。

. Cloud Backup for Applicationsは、HANAデータベースからテナントのリストを読み取ります。
. テナント情報は、バックアップ処理用にCloud Backup for Applicationsメタデータに格納されます。
. Cloud Backup for Applicationsは、SAP HANAのグローバル同期バックアップセーブポイントをトリガーして、永続性レイヤに整合性のあるデータベースイメージを作成します。
+

NOTE: SAP HANA MDCのシングルテナントシステムまたはマルチテナントシステムの場合、システムデータベースと各テナントデータベースの同期されたグローバルバックアップセーブポイントが1回の操作で作成されます。

. Cloud Backup for Applicationsでは、HANAシステム用に設定されたすべてのデータボリュームのANF Snapshotコピーが作成されます。シングルホストのHANAデータベースの場合、データボリュームは1つだけです。SAP HANA マルチホストデータベースには、複数のデータボリュームがあります。
. Cloud Backup for Applicationsは、SnapshotバックアップをSAP HANAバックアップカタログに登録します。
. Cloud Backup for Applicationsにより、SAP HANAのバックアップセーブポイントが削除されます。
. Cloud Backup for Applicationsでは、バックアップに対して定義された保持ポリシーに基づいて、ANF SnapshotコピーとデータベースおよびSAP HANAバックアップカタログ内のバックアップエントリが削除されます。HANAバックアップカタログ処理は、システムデータベースとすべてのテナントに対して実行されます。
. Cloud Backup for Applicationsでは、ファイルシステム上のログバックアップとSAP HANAバックアップカタログ内の、成功した最も古いデータバックアップよりも古いログバックアップがすべて削除されます。これらの処理は、システムデータベースとすべてのテナントに対して実行されます。




=== ブロック整合性チェック処理のバックアップワークフロー

Cloud Backup for Applicationsは、ブロックの整合性チェックを次の順序で実行します。

. Cloud Backup for Applicationsは、HANAデータベースからテナントのリストを読み取ります。
. Cloud Backup for Applicationsは、システムデータベースと各テナントに対してファイルベースのバックアップ処理をトリガーします。
. Cloud Backup for Applicationsは、ブロック整合性チェック処理用に定義された保持ポリシーに基づいて、データベース、ファイルシステム、およびSAP HANAバックアップカタログのファイルベースのバックアップを削除します。ファイルシステムでのバックアップの削除処理とHANAバックアップカタログの削除処理が、システムデータベースとすべてのテナントに対して実行されます。
. Cloud Backup for Applicationsでは、ファイルシステム上のログバックアップとSAP HANAバックアップカタログ内の、SAP HANAバックアップカタログに指定された最も古いデータバックアップよりも古いログバックアップがすべて削除されます。これらの処理は、システムデータベースとすべてのテナントに対して実行されます。




== バックアップ保持管理、および不要なデータバックアップとログバックアップの削除

データバックアップの保持管理とログバックアップの不要な管理は、主に次の4つの領域に分けられます。

* Snapshot バックアップ
* ファイルベースのバックアップ
* SAP HANA のバックアップカタログでのデータのバックアップ
* SAP HANA のバックアップカタログとファイルシステムにバックアップを記録します


次の図は、各種ワークフローの概要と各処理の依存関係を示しています。以降のセクションでは、さまざまな処理について詳しく説明します。

image:anf-cba-image9.png["この図は、さまざまなワークフローと各処理の依存関係の概要を示しています。"]



=== Snapshot バックアップの保持管理

Cloud Backup for Applicationsは、Cloud Backup for Applicationsバックアップポリシーに定義されている保持期間に従って、ストレージとCloud Backup for ApplicationsリポジトリにあるSnapshotコピーを削除することで、SAP HANAデータベースのバックアップやデータボリューム以外のバックアップの不要な削除を処理します。

保持管理ロジックは、Cloud Backup for Applicationsのバックアップワークフローごとに実行されます。

Cloud Backup for Applicationsでは、Snapshotバックアップを手動で削除することもできます。



=== ファイルベースのバックアップの保持管理

Cloud Backup for Applicationsは、Cloud Backup for Applicationsバックアップポリシーで定義された保持期間に従ってファイルシステム上のバックアップを削除することで、不要なファイルベースのバックアップの削除を処理します。

保持管理ロジックは、Cloud Backup for Applicationsのバックアップワークフローごとに実行されます。



=== SAP HANA のバックアップカタログ内でのデータバックアップの保持管理

Cloud Backup for Applicationsでバックアップ（Snapshotベースまたはファイルベース）が削除されると、そのデータバックアップもSAP HANAのバックアップカタログから削除されます。



=== ログバックアップの保持管理

SAP HANA データベースでは、ログバックアップが自動的に作成されます。これらのログバックアップ実行では、SAP HANAで設定されたバックアップディレクトリに、個 々 のSAP HANAサービスのバックアップファイルが作成されます。

成功した最も古いデータバックアップよりも古いログバックアップは、フォワードリカバリでは不要になるため、削除できます。

Cloud Backup for Applicationsは、次の手順を実行して、ファイルシステムレベルおよびSAP HANAバックアップカタログで不要なログファイルのバックアップを削除します。

* Cloud Backup for Applicationsは、SAP HANAのバックアップカタログを読み取り、成功したファイルベースまたはSnapshotの最も古いバックアップのバックアップIDを取得します。
* Cloud Backup for Applicationsでは、SAP HANAカタログおよびファイルシステム内の、このバックアップIDより古いログバックアップがすべて削除されます。



NOTE: Cloud Backup for Applicationsは、Cloud Backup for Applicationsで作成されたバックアップの不要な削除のみを処理します。Cloud Backup for Applications以外で追加でデータバックアップを作成する場合は、バックアップカタログからデータバックアップを削除する必要があります。このようなデータバックアップをバックアップカタログから手動で削除しないと、そのバックアップが最も古いデータバックアップになり、古いログバックアップはこのデータバックアップが削除されるまで削除されません。


NOTE: ログバックアップ不要の削除はデフォルトで有効になっていますが、HANAプラグインのホストレベルで無効にすることができます。を編集します `hana.property` ファイル。 `/opt/NetApp/snapcenter/scc/etc`。パラメータも含まれます `LOG_CLEANUP_DISABLE = Y` を参照してください `hana.property` 構成ファイルは、ログバックアップ不要の削除を無効にします。ファイルが存在しない場合は、作成する必要があります。



== HANAデータベースとのセキュアな通信を有効にします

HANAデータベースにセキュアな通信が設定されている場合は、 `hdbsql` CBAによって実行されるコマンドは、追加のコマンドラインオプションを使用する必要があります。これは、を呼び出すラッパースクリプトを使用して実現できます `hdbsql` 必要なオプションを指定します。


NOTE: SSL通信を設定するためのさまざまなオプションがあります。次の例では、コマンドラインオプションを使用して最も単純なクライアント設定について説明します。この場合、サーバ証明書の検証は行われません。サーバー側またはクライアント側で証明書の検証が必要な場合は、別のhdbsqlコマンドラインオプションが必要であり、『SAP HANA Security Guide』の説明に従ってPSE環境を構成する必要があります。

を設定する代わりに `hdbsql` で実行できます `hana.properties` ファイルの場合は、ラッパースクリプトを追加します。をクリックします `/opt/NetApp/snapcenter/scc/etc/hana.properties`の場合は、次の内容を追加する必要があります。ファイルが存在しない場合は、作成する必要があります。

この例は、SIDがSM1でインスタンス番号が12のHANAシステムを対象としています。

....
HANA_HDBSQL_CMD = /usr/sap/SM1/HDB12/exe/hdbsqls
....
ラッパースクリプト「 hdbsqls 」は、必要なコマンドラインオプションを指定して「 hdbsql 」を呼び出します。

....
#/bin/bash
/usr/sap/SM1/HDB12/exe/hdbsql -e -ssltrustcert $*
....


== Snapshot バックアップに必要な容量

従来のデータベースの変更率と比較して、ストレージレイヤのブロック変更率が高いことを考慮する必要があります。列ストアのHANAテーブルマージプロセスにより、テーブル内の変更されたデータだけでなく、テーブル全体がディスクに書き込まれます。

当社の顧客ベースのデータでは、1日に複数のSnapshotバックアップを作成した場合、1日あたりの変更率は20~50%です。

link:anf-cba-overview-of-installation-and-configuration-steps.html["次の記事：インストールと設定の手順の概要"]
