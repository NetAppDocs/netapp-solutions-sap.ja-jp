---
sidebar: sidebar 
permalink: backup/hana-sr-scs-4.6-config-using-resource-group.html 
keywords: resource group, configuration, discovery, retention management 
summary: SnapCenter 4.6 では、 HANA システムレプリケーションが設定された HANA システムの自動検出がサポートされます。SnapCenter 4.6 には、バックアップ処理中にプライマリおよびセカンダリの HANA ホストを識別し、両方の HANA ホスト間で保持管理を処理するロジックが含まれています。 
---
= リソースグループを使用した SnapCenter 4.6 の設定
:hardbreaks:
:allow-uri-read: 
:nofooter: 
:icons: font
:linkattrs: 
:imagesdir: ../media/


[role="lead"]
SnapCenter 4.6 では、 HANA システムレプリケーションが設定された HANA システムの自動検出がサポートされます。SnapCenter 4.6 には、バックアップ処理中にプライマリおよびセカンダリの HANA ホストを識別し、両方の HANA ホスト間で保持管理を処理するロジックが含まれています。また、 HANA システムレプリケーション環境でも自動リストアと自動リカバリが利用できるようになりました。



== SnapCenter 4.6 HANA システムレプリケーション環境の構成

次の図に、この章で使用するラボのセットアップを示します。HANA システムレプリケーションを使用して、 HANA ホストを 2 台、 HANA を 3 台、 HANA を 4 台構成しました。

HANAシステムデータベース用に、バックアップおよびリカバリ操作を実行するために必要な権限を持つデータベースユーザー「SnapCenter」が作成されました（ link:hana-sc-generic-scope.html["SnapCenter を使用した SAP HANA のバックアップとリカバリ"^]）。上記のデータベース ユーザーを使用して、両方のホストで HANA ユーザー ストア キーを構成する必要があります。

....
ss2adm@hana- 3: / > hdbuserstore set SS2KEY hana- 3:33313 SNAPCENTER <password>
....
....
ss2adm@hana- 4:/ > hdbuserstore set SS2KEY hana-4:33313 SNAPCENTER <password>
....
SnapCenter で HANA システムのレプリケーションを設定するには、大まかに見て次の手順を実行する必要があります。

. HANA プラグインをプライマリホストとセカンダリホストにインストールします。自動検出が実行され、各プライマリホストまたはセカンダリホストで HANA システムのレプリケーションステータスが検出されます。
. SnapCenter の configure database を実行し 'hdbuserstore キーを指定しますさらに自動検出操作が実行されます。
. 両方のホストを含むリソースグループを作成し、保護を設定します。


image:saphana-sr-scs-image6.png["入力/出力ダイアログを示す図、または書き込まれた内容を表す図"]

両方の HANA ホストに SnapCenter HANA プラグインをインストールすると、他の自動検出されたリソースと同じように、 HANA システムが SnapCenter リソースビューに表示されます。SnapCenter 4.6 以降では、追加の列に HANA システムレプリケーション（有効 / 無効、プライマリ / セカンダリ）のステータスが表示されます。

image:saphana-sr-scs-image7.png["入力/出力ダイアログを示す図、または書き込まれた内容を表す図"]

リソースをクリックすると、 SnapCenter は HANA システムの HANA ユーザストアキーを要求します。

image:saphana-sr-scs-image8.png["入力/出力ダイアログを示す図、または書き込まれた内容を表す図"]

追加の自動検出ステップが実行され、 SnapCenter にリソースの詳細が表示されます。SnapCenter 4.6 では、システムレプリケーションのステータスとセカンダリサーバがこのビューに表示されます。

image:saphana-sr-scs-image9.png["入力/出力ダイアログを示す図、または書き込まれた内容を表す図"]

2 つ目の HANA リソースに対して同じ手順を実行すると、自動検出プロセスが完了し、両方の HANA リソースが SnapCenter で構成されます。

image:saphana-sr-scs-image10.png["入力/出力ダイアログを示す図、または書き込まれた内容を表す図"]

HANA システムレプリケーションを有効にしたシステムでは、両方の HANA リソースを含む SnapCenter リソースグループを設定する必要があります。

image:saphana-sr-scs-image11.png["入力/出力ダイアログを示す図、または書き込まれた内容を表す図"]

Snapshot 名には、ホスト名、ポリシー、スケジュールなどを含めるカスタムの名前形式を使用することを推奨します。

image:saphana-sr-scs-image12.png["入力/出力ダイアログを示す図、または書き込まれた内容を表す図"]

リソースグループに両方の HANA ホストを追加する必要があります。

image:saphana-sr-scs-image13.png["入力/出力ダイアログを示す図、または書き込まれた内容を表す図"]

リソースグループにはポリシーとスケジュールが設定されます。


NOTE: ポリシーで定義された保持設定は、両方の HANA ホストで使用されます。たとえば、ポリシーで保持数が 10 に定義されている場合、両方のホストのバックアップの合計がバックアップ削除の基準として使用されます。SnapCenter は、現在のプライマリホストまたはセカンダリホストに作成された最も古いバックアップを個別に削除します。

image:saphana-sr-scs-image14.png["入力/出力ダイアログを示す図、または書き込まれた内容を表す図"]

これでリソースグループの設定が終了し、バックアップを実行できるようになります。

image:saphana-sr-scs-image15.png["入力/出力ダイアログを示す図、または書き込まれた内容を表す図"]

image:saphana-sr-scs-image16.png["入力/出力ダイアログを示す図、または書き込まれた内容を表す図"]



== Snapshot のバックアップ処理

リソースグループのバックアップ処理が実行されると、 SnapCenter はどのホストがプライマリであるかを識別し、プライマリホストでのみバックアップをトリガーします。つまり、プライマリホストのデータボリュームのみが Snapshot されます。この例では、 HANA 3 が現在のプライマリホストであり、このホストでバックアップが実行されています。

image:saphana-sr-scs-image17.png["入力/出力ダイアログを示す図、または書き込まれた内容を表す図"]

SnapCenter ジョブログには、識別処理と、現在のプライマリホスト HANA でのバックアップの実行が表示されます。

image:saphana-sr-scs-image18.png["入力/出力ダイアログを示す図、または書き込まれた内容を表す図"]

これで、プライマリ HANA リソースに Snapshot バックアップが作成されました。バックアップ名に含まれるホスト名は HANA - 3 と表示されます。

image:saphana-sr-scs-image19.png["入力/出力ダイアログを示す図、または書き込まれた内容を表す図"]

HANA のバックアップカタログにも同じ Snapshot バックアップが表示されます。

image:saphana-sr-scs-image20.png["入力/出力ダイアログを示す図、または書き込まれた内容を表す図"]

テイクオーバー処理が実行されると、それ以降の SnapCenter バックアップで元のセカンダリホスト（ Hana-4 ）がプライマリとして識別され、 Hana-4 でバックアップ処理が実行されるようになります。ここでも、新しいプライマリホスト（ HANA - 4 ）のデータボリュームのみが Snapshot されています。


NOTE: SnapCenter 識別ロジックで対応しているのは、 HANA ホストがプライマリとセカンダリの関係にあるシナリオと、 HANA ホストの 1 つがオフラインになっているシナリオだけです。

image:saphana-sr-scs-image21.png["入力/出力ダイアログを示す図、または書き込まれた内容を表す図"]

SnapCenter ジョブログには、識別処理と、現在のプライマリホスト HANA でのバックアップの実行が表示されます。

image:saphana-sr-scs-image22.png["入力/出力ダイアログを示す図、または書き込まれた内容を表す図"]

これで、プライマリ HANA リソースに Snapshot バックアップが作成されました。バックアップ名に含まれているホスト名は、 HANA のホスト名です。

image:saphana-sr-scs-image23.png["入力/出力ダイアログを示す図、または書き込まれた内容を表す図"]

HANA のバックアップカタログにも同じ Snapshot バックアップが表示されます。

image:saphana-sr-scs-image24.png["入力/出力ダイアログを示す図、または書き込まれた内容を表す図"]



== ファイルベースのバックアップを使用したブロック整合性チェック処理

SnapCenter 4.6 では、ファイルベースのバックアップでブロック整合性チェック処理を実行する場合と同じロジックを使用します。SnapCenter は現在のプライマリ HANA ホストを識別し、このホストに対してファイルベースのバックアップを実行します。保持管理も両方のホスト間で実行されるため、現在プライマリになっているホストに関係なく、最も古いバックアップが削除されます。



== SnapVault レプリケーション

テイクオーバー時に透過的なバックアップ処理を可能にし、現在プライマリホストになっている HANA ホストに依存しないようにするには、両方のホストのデータボリュームに SnapVault 関係を設定する必要があります。SnapCenter は、バックアップの実行ごとに、現在のプライマリホストに対して SnapVault 更新処理を実行します。


NOTE: セカンダリホストへのテイクオーバーが長時間実行されない場合、セカンダリホストでの最初の SnapVault 更新で変更されたブロック数は多くなります。

SnapVault ターゲットの保持管理は ONTAP by SnapCenter の外部で管理されるため、両方の HANA ホスト間で処理することはできません。そのため、テイクオーバー前に作成されたバックアップは、以前のセカンダリではバックアップ処理によって削除されません。これらのバックアップは、元のプライマリが再びプライマリになるまで保持されます。これらのバックアップによってログバックアップの保持管理がブロックされないように、 SnapVault ターゲットまたは HANA のバックアップカタログから手動で削除する必要があります。


NOTE: 1 つの SnapVault コピーが同期ポイントとしてブロックされるため、すべての Snapshot コピーのクリーンアップを実行できません。最新の Snapshot コピーも削除する必要がある場合は、 SnapVault レプリケーション関係を削除してください。この場合は、 HANA のバックアップカタログ内のバックアップを削除して、ログのバックアップ保持管理のブロックを解除することを推奨します。

image:saphana-sr-scs-image25.png["入力/出力ダイアログを示す図、または書き込まれた内容を表す図"]



== 保持管理

SnapCenter 4.6 は、両方の HANA ホストで Snapshot バックアップ、ブロック整合性チェック処理、 HANA バックアップカタログのエントリ、ログバックアップ（無効になっていない場合）の保持を管理できるため、どちらのホストが現在プライマリであるかセカンダリであるかは関係ありません。削除処理が現在のプライマリホストとセカンダリホストのどちらで必要かに関係なく、定義された保持設定に基づいて HANA カタログのバックアップ（データとログ）とエントリが削除されます。つまり、テイクオーバー処理を実行した場合や、レプリケーションが反対方向に設定されている場合は、手動での操作は必要ありません。

SnapVaultレプリケーションがデータ保護戦略の一部である場合は、特定のシナリオについて手動での操作が必要です。詳細については、セクションを参照してください。link:#snapvault-replication["SnapVaultレプリケーション"]



== リストアとリカバリ

次の図は、複数のテイクオーバーが実行され、両方のサイトに Snapshot バックアップが作成された場合のシナリオを示しています。現在のステータスでは、ホスト HA-3 がプライマリホスト、最新のバックアップは T4 であり、これはホスト HA-3 で作成されています。リストアおよびリカバリ処理を実行する必要がある場合、バックアップ T1 および T4 は SnapCenter のリストアとリカバリに使用できます。ホスト HA-4 （ T2 、 T3 ）で作成されたバックアップは、 SnapCenter を使用してリストアできません。リカバリのために、これらのバックアップを HANA のデータボリュームに手動でコピーする必要があります。

image:saphana-sr-scs-image26.png["入力/出力ダイアログを示す図、または書き込まれた内容を表す図"]

SnapCenter 4.6 リソース グループ構成の復元およびリカバリ操作は、自動検出された非システム レプリケーション セットアップと同じです。復元と自動回復のすべてのオプションが利用可能です。詳細については、技術レポートをご覧ください。 link:hana-sc-generic-scope.html["SnapCenter を使用した SAP HANA のバックアップとリカバリ"^]。

もう一方のホストで作成されたバックアップからのリストア処理については、セクションで説明しlink:hana-sr-scs-restore-recovery-other-host-backup.html["他のホストで作成されたバックアップからのリストアとリカバリ"]ます。
